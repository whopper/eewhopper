version: 1.3.0

variables:
  global:
    COMPOSER_BIN: $SOURCE_DIR/vendor/bin
    BLT_DIR: $SOURCE_DIR/vendor/acquia/blt

cde-databases:
  - testdb1
  - testmigratedb1

events:
  build:
    steps:
      - setup-env:
          type: script
          script:
            - pushd docroot
            - composer install
            - mkdir -p sites/default/files
            - sed -i "s/SITEGROUP/${PIPELINE_CLOUD_SITE}" ../settings.php
            - sed -i "s/DBROLE/$(echo $CDE_DATABASES | awk -F ',' '{print $1}')/" ../settings.php
            - cp ../settings.php ./sites/default
            # Next:
            # Automate settings.php if possible
            # See if we can drush-install with some sane basics
  post-deploy:
    steps:
      - deploy:
          script:
            - pipelines-deploy
