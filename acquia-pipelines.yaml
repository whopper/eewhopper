version: 1.3.0

variables:
  global:
    COMPOSER_BIN: $SOURCE_DIR/vendor/bin

cde-databases:
  - testdb1
  - testmigratedb1

events:
  build:
    steps:
      - setup-env:
          type: script
          script:
            - pushd docroot
            - composer install
            - mkdir -p sites/default/files
            - sed -i "s/SITEGROUP/${PIPELINE_CLOUD_SITE}/" ../settings.php
            - sed -i "s/DBROLE/$(echo $CDE_DATABASES | awk -F ',' '{print $1}')/" ../settings.php
            - cp ../settings.php ./sites/default
  post-deploy:
    steps:
      - deploy:
          script:
            - pipelines-deploy
            # We can't site-install inside of pipelines, it seems. This results in:
            # Drush\Sql\SqlException: Unable to find a matching SQL Class. Drush       [error]
            # cannot find your database connection details. in
            # /usr/local/drush8/vendor/drush/drush/commands/sql/sql.drush.inc:577
            #- pushd docroot && /usr/local/bin/drush8 site-install --account-name='admin' --account-mail='foo@bar.com' --site-mail='foo@bar.com' --account-pass='randompass' --site-name='Drupal 8'
